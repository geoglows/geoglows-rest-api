# CI Pipeline
name: Build 

on: 
  push: 
    branches:
      - "*"
    tags: 
      - "*"

  pull_request:
    branches:
      - "*"

env:
  HELM_REPO_URL: https://eccr.ecmwf.int
  HELM_CHART: ${{ github.workspace }}/helm/gsprestapi
  HELM_REPO_USERNAME: ${{ secrets.HELM_REPO_USERNAME }}
  HELM_KEY_PASSPHRASE: ${{ secrets.HELM_KEY_PASSPHRASE }}
  HELM_REPO_PASSWORD: ${{ secrets.HELM_REPO_PASSWORD }}
  CI_REGISTRY_USER: ${{ secrets.CI_REGISTRY_USER }}
  CI_REGISTRY_PASSWORD: ${{ secrets.CI_REGISTRY_PASSWORD }}
  CI_REGISTRY_IMAGE: docker.aquaveo.com/tethys/gsprestapi
  CI_COMMIT_SHORT_SHA: ${{ github.sha }}
  ECCR_USER: ${{ secrets.ECCR_USER }}
  ECCR_PASSWORD: ${{ secrets.ECCR_PASSWORD }}
  KANIKO_DOCKERFILE: ${{ github.workspace }}/Dockerfile
  KANIKO_CONTEXT: ${{ github.workspace }}


jobs:
  check-helm: 
      name: Check Helm
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            submodules: false
          
        - name: Ensure HELM_CHART is set
          run: |
            if [[ -z "${HELM_CHART}" ]]; then
              echo "HELM_CHART must be set" >&2
              exit 1
            fi

        - name: Lint Helm Chart
          run: helm lint $HELM_CHART

        - name: Run Check Helm Script
          run: |
            chmod +x ./check_helm_chart
            ./check_helm_chart $HELM_CHART

  update-helm: 
    runs-on: ubuntu-latest
    needs: check-helm
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Ensure Required Variables Are Set
        run: |
          : "${HELM_CHART:?must be set}"
          : "${HELM_KEY_PASSPHRASE:?must be set}"
          : "${HELM_REPO_PASSWORD:?must be set}"

      - name: Run Helm Lint
        run: helm lint $HELM_CHART

      - name: Run Check Helm Script and Upload
        run: |
          chmod +x ./check_helm_chart
          ./check_helm_chart $HELM_CHART --upload

  prep_code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Upload Source Code as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: .

  kaniko-build:
    runs-on: ubuntu-latest
    needs: prep_code
    container:
      image: gcr.io/kaniko-project/executor:debug
      options: --entrypoint ""
    strategy:
      matrix:
        build_type: [tag, stable]
   

    steps:
      - name: Download Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code
      
      - name: Set Docker Config
        if: matrix.build_type == 'tag' && startsWith(github.ref, 'refs/tags/') || matrix.build_type == 'stable' && github.ref_name == 'main'
        run: |
          echo "{\"auths\":{
            \"$CI_REGISTRY\": {
              \"username\":\"$CI_REGISTRY_USER\", 
              \"password\":\"$CI_REGISTRY_PASSWORD\"
            },
            \"eccr.ecmwf.int/harbor\": {
              \"username\":\"$ECCR_USER\", 
              \"password\":\"$ECCR_PASSWORD\"
            }
          }}" > /kaniko/.docker/config.json

      - name: Set Kaniko Build Variables
        if: matrix.build_type == 'tag' && startsWith(github.ref, 'refs/tags/') || matrix.build_type == 'stable' && github.ref_name == 'main'
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          if [[ "${{ matrix.build_type }}" == "tag" ]]; then
            echo "KANIKO_DESTINATIONS='eccr.ecmwf.int/geoglows_api/geoglows_api:${{ github.ref_name }} eccr.ecmwf.int/geoglows_api/geoglows_api:latest'" >> $GITHUB_ENV
          elif [[ "${{ matrix.build_type }}" == "stable" && "${{ github.ref_name }}" == "main" ]]; then
            echo "KANIKO_DESTINATIONS='eccr.ecmwf.int/geoglows_api/geoglows_api:stable'" >> $GITHUB_ENV
          else
            echo "No valid build type" >&2
            exit 1
          fi

      - name: Run Kaniko Build & Push
        if: matrix.build_type == 'tag' && startsWith(github.ref, 'refs/tags/') || matrix.build_type == 'stable' && github.ref_name == 'main'
        run: |
          # Ensure required vars are set
          [[ -z "${KANIKO_DOCKERFILE}" ]] && echo "KANIKO_DOCKERFILE must be set" && exit 1
          [[ -z "${KANIKO_CONTEXT}" ]] && echo "KANIKO_CONTEXT must be set" && exit 1
          [[ -z "${KANIKO_DESTINATIONS}" ]] && echo "KANIKO_DESTINATIONS must be set" && exit 1

          # Build the Kaniko command
          KANIKO_CMD="/kaniko/executor --context ${KANIKO_CONTEXT} --dockerfile ${KANIKO_DOCKERFILE}"

          for DEST in $KANIKO_DESTINATIONS; do
            KANIKO_CMD="$KANIKO_CMD --destination $DEST"
          done

          KANIKO_CMD="$KANIKO_CMD --cache=true --cache-repo ${CI_REGISTRY_IMAGE}/cache --force"

          echo "$KANIKO_CMD"
          eval $KANIKO_CMD
        env:
          KANIKO_DOCKERFILE: ${{ env.KANIKO_DOCKERFILE }}
          KANIKO_CONTEXT: ${{ env.KANIKO_CONTEXT }}
          KANIKO_DESTINATIONS: ${{ env.KANIKO_DESTINATIONS }}
          CI_REGISTRY_IMAGE: ${{ env.CI_REGISTRY_IMAGE }}
            